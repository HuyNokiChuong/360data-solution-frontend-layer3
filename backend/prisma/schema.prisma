// Prisma schema for 360data-solution
// Multi-tenant architecture with workspace isolation by email domain

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// CORE: Workspace & Users
// ===========================================

model Workspace {
  id        String   @id @default(uuid())
  domain    String   @unique // email domain (company.com)
  name      String?
  settings  Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  users          User[]
  connections    Connection[]
  folders        BIFolder[]
  dashboards     BIDashboard[]
  reportSessions ReportSession[]
  systemLogs     SystemLog[]
  syncedTables   SyncedTable[]
  aiSettings     AISetting[]

  @@map("workspaces")
}

model AISetting {
  id          String   @id @default(uuid())
  workspaceId String   @map("workspace_id")
  provider    String   // OpenAI, Gemini, Anthropic
  apiKey      String   @map("api_key")
  settings    Json     @default("{}")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, provider])
  @@index([workspaceId])
  @@map("ai_settings")
}

model User {
  id           String    @id @default(uuid())
  workspaceId  String    @map("workspace_id")
  email        String    @unique
  passwordHash String?   @map("password_hash")
  name         String?
  role         String    @default("Viewer") // Admin, Editor, Viewer
  status       String    @default("Pending") // Active, Pending, Disabled
  phoneNumber  String?   @map("phone_number")
  jobTitle     String?   @map("job_title")
  level        String?
  department   String?
  industry     String?
  companySize  String?   @map("company_size")
  joinedAt     DateTime  @default(now()) @map("joined_at")
  lastLogin    DateTime? @map("last_login")
  verificationCode String? @map("verification_code")
  verificationExpiresAt DateTime? @map("verification_expires_at")

  // Relations
  workspace        Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  sessions         Session[]
  createdDashboards BIDashboard[]    @relation("DashboardCreator")
  createdFolders   BIFolder[]        @relation("FolderCreator")
  createdConnections Connection[]    @relation("ConnectionCreator")
  reportSessions   ReportSession[]
  sharePermissions SharePermission[]

  @@index([workspaceId])
  @@index([email])
  @@map("users")
}

model Session {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  token      String   @unique
  deviceInfo Json?    @map("device_info")
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")
  expiresAt  DateTime @map("expires_at")
  lastActive DateTime @default(now()) @map("last_active")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("sessions")
}

// ===========================================
// DATA CONNECTIONS
// ===========================================

model Connection {
  id                   String   @id @default(uuid())
  workspaceId          String   @map("workspace_id")
  name                 String
  type                 String   // BigQuery, Snowflake, PostgreSQL, Excel, GoogleSheets
  authType             String?  @map("auth_type") // GoogleMail, ServiceAccount, Password
  email                String?
  status               String   @default("Connected")
  projectId            String?  @map("project_id")
  serviceAccountKey    String?  @map("service_account_key") @db.Text
  credentialsEncrypted String?  @map("credentials_encrypted") @db.Text
  createdAt            DateTime @default(now()) @map("created_at")
  createdById          String?  @map("created_by")

  // Relations
  workspace    Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy    User?         @relation("ConnectionCreator", fields: [createdById], references: [id])
  syncedTables SyncedTable[]

  @@index([workspaceId])
  @@map("connections")
}

model SyncedTable {
  id           String    @id @default(uuid())
  connectionId String    @map("connection_id")
  workspaceId  String    @map("workspace_id")
  tableName    String    @map("table_name")
  datasetName  String?   @map("dataset_name")
  rowCount     BigInt    @default(0) @map("row_count")
  status       String    @default("Active")
  lastSync     DateTime? @map("last_sync")
  schema       Json?

  // Relations
  workspace  Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  connection Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([connectionId, datasetName, tableName])
  @@index([connectionId])
  @@index([workspaceId])
  @@map("synced_tables")
}

// ===========================================
// BI DASHBOARD SYSTEM
// ===========================================

model BIFolder {
  id          String   @id @default(uuid())
  workspaceId String   @map("workspace_id")
  parentId    String?  @map("parent_id")
  name        String
  icon        String?
  color       String?
  createdAt   DateTime @default(now()) @map("created_at")
  createdById String?  @map("created_by")

  // Relations
  workspace  Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  parent     BIFolder?     @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children   BIFolder[]    @relation("FolderHierarchy")
  createdBy  User?         @relation("FolderCreator", fields: [createdById], references: [id])
  dashboards BIDashboard[]

  @@index([workspaceId])
  @@index([parentId])
  @@map("bi_folders")
}

model BIDashboard {
  id                String   @id @default(uuid())
  workspaceId       String   @map("workspace_id")
  folderId          String?  @map("folder_id")
  title             String
  description       String?  @db.Text
  dataSourceId      String?  @map("data_source_id")
  dataSourceName    String?  @map("data_source_name")
  enableCrossFilter Boolean  @default(false) @map("enable_cross_filter")
  activePageId      String?  @map("active_page_id")
  layout            Json?
  theme             Json?
  calculatedFields  Json     @default("[]") @map("calculated_fields")
  quickMeasures     Json     @default("[]") @map("quick_measures")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at")
  createdById       String?  @map("created_by")

  // Relations
  workspace     Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  folder        BIFolder?         @relation(fields: [folderId], references: [id], onDelete: SetNull)
  createdBy     User?             @relation("DashboardCreator", fields: [createdById], references: [id])
  pages         DashboardPage[]
  globalFilters GlobalFilter[]
  permissions   SharePermission[]

  @@index([workspaceId])
  @@index([folderId])
  @@map("bi_dashboards")
}

model DashboardPage {
  id             String   @id @default(uuid())
  dashboardId    String   @map("dashboard_id")
  title          String
  dataSourceId   String?  @map("data_source_id")
  dataSourceName String?  @map("data_source_name")
  position       Int      @default(0)
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  dashboard BIDashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  widgets   BIWidget[]

  @@index([dashboardId])
  @@map("dashboard_pages")
}

model BIWidget {
  id        String   @id @default(uuid())
  pageId    String   @map("page_id")
  type      String   // chart, table, card, slicer, gauge, date-range, search, pivot
  title     String?
  chartType String?  @map("chart_type")
  x         Int      @default(0)
  y         Int      @default(0)
  w         Int      @default(4)
  h         Int      @default(4)
  config    Json     @default("{}") // All other widget settings
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  page DashboardPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId])
  @@map("bi_widgets")
}

model GlobalFilter {
  id                String   @id @default(uuid())
  dashboardId       String   @map("dashboard_id")
  name              String?
  field             String
  operator          String?
  value             Json?
  appliedToWidgets  String[] @default([]) @map("applied_to_widgets")

  // Relations
  dashboard BIDashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)

  @@index([dashboardId])
  @@map("global_filters")
}

// ===========================================
// REPORT & AI SESSIONS
// ===========================================

model ReportSession {
  id          String   @id @default(uuid())
  workspaceId String   @map("workspace_id")
  userId      String?  @map("user_id")
  title       String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  workspace Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User?         @relation(fields: [userId], references: [id])
  messages  ChatMessage[]

  @@index([workspaceId])
  @@index([userId])
  @@map("report_sessions")
}

model ChatMessage {
  id            String   @id @default(uuid())
  sessionId     String   @map("session_id")
  role          String   // user, assistant
  content       String   @db.Text
  visualData    Json?    @map("visual_data") // DashboardConfig
  sqlTrace      String?  @map("sql_trace") @db.Text
  executionTime Int?     @map("execution_time")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  session ReportSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("chat_messages")
}

// ===========================================
// SHARING & PERMISSIONS
// ===========================================

model SharePermission {
  id           String   @id @default(uuid())
  resourceType String   @map("resource_type") // dashboard, folder
  resourceId   String   @map("resource_id")
  userId       String   @map("user_id")
  permission   String   @default("view") // view, edit, admin
  sharedAt     DateTime @default(now()) @map("shared_at")

  // Relations
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  dashboard BIDashboard? @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([resourceType, resourceId, userId])
  @@index([userId])
  @@map("share_permissions")
}

// ===========================================
// SYSTEM LOGS
// ===========================================

model SystemLog {
  id          String   @id @default(uuid())
  workspaceId String   @map("workspace_id")
  logType     String?  @map("log_type")
  message     String?  @db.Text
  target      String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([createdAt])
  @@map("system_logs")
}
